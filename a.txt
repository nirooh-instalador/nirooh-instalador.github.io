#!/bin/bash

set -e

LIB_NAME="libayatana-appindicator3.so.1"
LIB_DIR="$HOME/lib"
DEB_URL="http://ftp.de.debian.org/debian/pool/main/liba/libayatana-appindicator/libayatana-appindicator3-1_0.5.92-1_amd64.deb"
DEB_FILE="libayatana-appindicator3-1_0.5.92-1_amd64.deb"

# Verifica se a biblioteca jรก estรก instalada no sistema
echo "๐ Verificando biblioteca no sistema..."
if ldconfig -p | grep -q "$LIB_NAME"; then
    echo "โ Biblioteca $LIB_NAME jรก estรก disponรญvel no sistema."
    exit 0
fi

echo "๐ฅ Biblioteca nรฃo encontrada. Iniciando instalaรงรฃo local..."

# Cria diretรณrio local
mkdir -p "$LIB_DIR"

# Baixa o .deb
echo "๐ฆ Baixando pacote .deb de $DEB_URL ..."
wget -q "$DEB_URL" -O "$DEB_FILE"

# Extrai o .deb
echo "๐ Extraindo arquivos do pacote .deb ..."
ar x "$DEB_FILE"
tar -xf data.tar.xz

# Copia a biblioteca para o diretรณrio local
echo "๐ Copiando biblioteca para $LIB_DIR ..."
cp -a usr/lib/x86_64-linux-gnu/libayatana-appindicator3.so.* "$LIB_DIR/"

# Cria link simbรณlico se necessรกrio
cd "$LIB_DIR"
if [ ! -f "$LIB_NAME" ]; then
    REAL_LIB=$(ls libayatana-appindicator3.so.*.*.* 2>/dev/null | head -n 1)
    if [ -n "$REAL_LIB" ]; then
        ln -s "$REAL_LIB" "$LIB_NAME"
        echo "๐ Link simbรณlico criado: $LIB_NAME โ $REAL_LIB"
    fi
fi

# Limpa arquivos temporรกrios
cd -
rm -rf "$DEB_FILE" control.tar.* data.tar.* debian-binary usr

# Adiciona export ao .bashrc ou .zshrc
SHELL_RC=""
if [[ "$SHELL" == *zsh ]]; then
    SHELL_RC="$HOME/.zshrc"
else
    SHELL_RC="$HOME/.bashrc"
fi

if ! grep -q "LD_LIBRARY_PATH=.*\$HOME/lib" "$SHELL_RC"; then
    echo "export LD_LIBRARY_PATH=\$HOME/lib:\$LD_LIBRARY_PATH" >> "$SHELL_RC"
    echo "โ Adicionado LD_LIBRARY_PATH ao $SHELL_RC"
else
    echo "๐ LD_LIBRARY_PATH jรก configurado em $SHELL_RC"
fi